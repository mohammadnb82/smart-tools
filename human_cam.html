
<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ø¯ÙˆØ±Ø¨ÛŒÙ† Ø§Ù…Ù†ÛŒØªÛŒ (Ø§Ù†Ø³Ø§Ù†)</title>
    <script src="assets/tf.min.js"></script>
    <script src="assets/coco-ssd.min.js"></script>
    <style>
        * { box-sizing: border-box; }
        body { margin: 0; background: #000; color: white; font-family: sans-serif; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        .toolbar {
            background: #111; padding: 5px 10px; display: flex; justify-content: space-between; align-items: center;
            border-bottom: 2px solid #ef4444; height: 60px;
        }
        .control-group { display: flex; align-items: center; gap: 10px; }
        label { font-size: 11px; color: #aaa; }
        input[type=range] { width: 80px; accent-color: #ef4444; }
        button {
            background: #222; color: white; border: 1px solid #444; padding: 5px 10px; border-radius: 5px; cursor: pointer;
        }
        #camera-wrapper {
            flex: 1; position: relative; background: #000; display: flex; align-items: center; justify-content: center; overflow: hidden;
        }
        video { width: 100%; height: 100%; object-fit: contain; }
        canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
        #best-shot-panel {
            height: 160px; background: #0a0a0a; border-top: 1px solid #333; display: flex;
            align-items: center; padding: 10px; gap: 15px;
        }
        .panel-info { flex: 1; font-size: 13px; color: #ccc; padding-right: 5px; }
        .panel-info h3 { margin: 0 0 5px 0; color: #ef4444; font-size: 16px; }
        .shot-container {
            width: 110px; height: 110px; background: #000; border: 2px dashed #444;
            border-radius: 8px; overflow: hidden; position: relative; display: flex; align-items: center; justify-content: center;
        }
        .shot-container img { width: 100%; height: 100%; object-fit: cover; }
        .score-badge {
            position: absolute; bottom: 0; right: 0; background: rgba(0,0,0,0.8);
            color: #ef4444; font-size: 10px; padding: 2px 4px; border-top-left-radius: 5px;
        }
        #status-overlay {
            position: absolute; top: 10px; left: 10px; background: rgba(0,0,0,0.6);
            color: #fff; padding: 4px 8px; border-radius: 4px; font-size: 11px; z-index: 10;
        }
    </style>
</head>
<body>
    <div class="toolbar">
        <a href="index.html" style="text-decoration: none; font-size: 20px;">ðŸ”™</a>
        <div style="font-weight: bold; color: #ef4444; font-size: 14px;">Ø¯ÙˆØ±Ø¨ÛŒÙ† Ø§Ù…Ù†ÛŒØªÛŒ (Ø§Ù†Ø³Ø§Ù†)</div>
        <div class="control-group">
            <div style="text-align: center;">
                <label>Ø­Ø³Ø§Ø³ÛŒØª: <span id="sense-val">50%</span></label><br>
                <input type="range" id="sensitivity" min="10" max="90" value="50" oninput="updateSense()">
            </div>
            <button id="mute-btn" onclick="toggleMute()">ðŸ”Š</button>
        </div>
    </div>

    <div id="camera-wrapper">
        <div id="status-overlay">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ...</div>
        <video id="webcam" autoplay playsinline muted></video>
        <canvas id="canvas"></canvas>
    </div>

    <div id="best-shot-panel">
        <div class="panel-info">
            <h3>Ø´Ú©Ø§Ø± Ù„Ø­Ø¸Ù‡â€ŒÙ‡Ø§ ðŸŽ¯</h3>
            <p id="shot-desc">Ù…Ù†ØªØ¸Ø± ØªØ´Ø®ÛŒØµ...</p>
        </div>
        <div class="shot-container" id="best-shot-box">
            <span style="color: #444; font-size: 30px;">Wait</span>
        </div>
    </div>

    <script>
        const video = document.getElementById('webcam');
        const canvas = document.getElementById('canvas');
        const statusOverlay = document.getElementById('status-overlay');
        const senseLabel = document.getElementById('sense-val');
        const senseInput = document.getElementById('sensitivity');
        const muteBtn = document.getElementById('mute-btn');
        const bestShotBox = document.getElementById('best-shot-box');
        const shotDesc = document.getElementById('shot-desc');

        let model = undefined;
        let isMuted = false;
        let detectionThreshold = 0.5;
        let bestScore = 0; 
        
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function beep() {
            if (isMuted) return;
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.frequency.value = 600;
            gain.gain.value = 0.05;
            osc.start();
            setTimeout(() => osc.stop(), 100);
        }

        function toggleMute() {
            isMuted = !isMuted;
            muteBtn.innerText = isMuted ? "ðŸ”‡" : "ðŸ”Š";
            muteBtn.style.opacity = isMuted ? "0.5" : "1";
        }

        function updateSense() {
            const val = senseInput.value;
            senseLabel.innerText = val + "%";
            detectionThreshold = val / 100;
        }

        cocoSsd.load().then(loadedModel => {
            model = loadedModel;
            statusOverlay.innerText = "âœ… AI ÙØ¹Ø§Ù„ Ø´Ø¯";
            startCamera();
        });

        async function startCamera() {
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({
                        'audio': false,
                        'video': { facingMode: 'environment' }
                    });
                    video.srcObject = stream;
                    video.onloadedmetadata = () => {
                        video.play();
                        canvas.width = video.videoWidth;
                        canvas.height = video.videoHeight;
                        detectFrame();
                    };
                } catch (err) {
                    statusOverlay.innerText = "âŒ Ø®Ø·Ø§: Ø¯ÙˆØ±Ø¨ÛŒÙ† Ø¯Ø± Ø¯Ø³ØªØ±Ø³ Ù†ÛŒØ³Øª";
                }
            }
        }

        function detectFrame() {
            if (!model) return;

            model.detect(video).then(predictions => {
                renderPredictions(predictions);
                requestAnimationFrame(detectFrame);
            });
        }

        function renderPredictions(predictions) {
            const ctx = canvas.getContext("2d");
            ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);

            let objectFound = false;

            predictions.forEach(prediction => {
                if (prediction.class === "person" && prediction.score > detectionThreshold) {
                    
                    objectFound = true;
                    const [x, y, width, height] = prediction.bbox;
                    
                    ctx.strokeStyle = "#FF0000";
                    ctx.lineWidth = 2;
                    ctx.strokeRect(x, y, width, height);
                    
                    ctx.fillStyle = "#FF0000";
                    ctx.font = "16px Arial";
                    ctx.fillText(prediction.class + " (" + Math.round(prediction.score*100) + "%)", x, y > 10 ? y - 5 : 10);

                    const frameScore = prediction.score * (width * height);

                    if (frameScore > bestScore) {
                        bestScore = frameScore;
                        updateBestShot(x, y, width, height, prediction.score, prediction.class);
                        beep();
                    }
                }
            });
            
            if (!objectFound && bestScore > 0) {
                bestScore -= 500; 
                if(bestScore < 0) bestScore = 0;
            }
        }

        function updateBestShot(x, y, w, h, score, label) {
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = w;
            tempCanvas.height = h;
            const tCtx = tempCanvas.getContext('2d');
            tCtx.drawImage(video, x, y, w, h, 0, 0, w, h);
            
            const imgUrl = tempCanvas.toDataURL('image/jpeg');

            bestShotBox.innerHTML = `
                <img src="${imgUrl}">
                <div class="score-badge">${label}</div>
            `;
            
            const time = new Date().toLocaleTimeString();
            shotDesc.innerHTML = `
                <span style="color:#ef4444">âœ… ${label}</span><br>
                Ø¯Ù‚Øª: ${Math.round(score * 100)}%<br>
                <span style="color:#666; font-size:10px">${time}</span>
            `;
        }
    </script>
</body>
</html>
    