<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Ø³ÛŒØ³ØªÙ… ÙÙˆÙ‚ Ù¾ÛŒØ´Ø±ÙØªÙ‡ Ø§Ù…Ù†ÛŒØªÛŒ</title>

<!-- Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù‡Ø³ØªÙ‡ Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ ØªÙ†Ø³ÙˆØ±ÙÙ„Ùˆ -->
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd"></script>

<style>
body {
    margin: 0;
    background: #050505;
    color: #00ffcc;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    text-align: center;
    padding-bottom: 80px;
}

header {
    padding: 20px;
    background: linear-gradient(180deg, #000 0%, #111 100%);
    border-bottom: 1px solid #00ffcc;
    box-shadow: 0 0 25px rgba(0, 255, 204, 0.2);
    margin-bottom: 25px;
}

h2 { margin: 0; font-size: 20px; letter-spacing: 1px; }

.container {
    display: flex;
    flex-direction: column;
    gap: 25px;
    padding: 10px;
    max-width: 700px;
    margin: 0 auto;
}

/* Ø§Ø³ØªØ§ÛŒÙ„ Ù¾Ù†Ù„â€ŒÙ‡Ø§ */
.panel {
    border: 1px solid #222;
    background: #111;
    padding: 15px;
    border-radius: 12px;
    position: relative;
    transition: all 0.3s ease;
}

.panel.active {
    border-color: #00ffcc;
    box-shadow: 0 0 15px rgba(0, 255, 204, 0.1);
    background: #161616;
}

.panel-title {
    font-weight: bold;
    font-size: 16px;
    display: block;
    color: #fff;
    margin-bottom: 5px;
    border-bottom: 1px solid #333;
    padding-bottom: 8px;
}

.panel-desc {
    font-size: 12px;
    color: #888;
    margin-bottom: 15px;
}

/* Ø§Ø³ØªØ§ÛŒÙ„ Ù…Ø®ØµÙˆØµ Ù¾Ù†Ù„ Ø¯Ùˆ ØªÚ©Ù‡ (AI) */
.split-view {
    display: flex;
    gap: 10px;
    justify-content: space-between;
    align-items: flex-start;
}

.view-box {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
}

.view-label {
    font-size: 11px;
    color: #aaa;
    margin-bottom: 5px;
}

.captured-image {
    width: 100%;
    height: 150px; /* Ø§Ø±ØªÙØ§Ø¹ Ø«Ø§Ø¨Øª Ø¨Ø±Ø§ÛŒ Ø²ÛŒØ¨Ø§ÛŒÛŒ */
    object-fit: contain;
    background-color: #000;
    border: 1px dashed #444;
    border-radius: 6px;
}
.captured-image.has-photo {
    border: 2px solid #ff3333;
    box-shadow: 0 0 10px #ff3333;
}

/* Ø§Ø³Ù„Ø§ÛŒØ¯Ø± */
.slider-container { margin: 15px 0; }
input[type=range] { width: 100%; accent-color: #00ffcc; cursor: pointer; }

/* ÙˆÛŒØ¯ÛŒÙˆ Ùˆ Ú©Ø§Ù†ÙˆØ§Ø³ */
video {
    position: absolute;
    top: 0; left: 0; width: 1px; height: 1px; opacity: 0; z-index: -1;
}

canvas {
    width: 100%;
    height: auto;
    border: 1px solid #333;
    background: #000;
    border-radius: 6px;
}

/* Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ */
.btn-row {
    margin-top: 15px;
    display: flex;
    gap: 10px;
}

button {
    border: none;
    padding: 12px 0;
    font-size: 14px;
    border-radius: 6px;
    cursor: pointer;
    font-weight: bold;
    flex: 1; 
    color: white;
}
.btn-start { background: #007755; }
.btn-stop { background: #772222; }

.status {
    margin-top: 10px;
    font-size: 13px;
    color: #555;
    font-weight: bold;
}
.alert { color: #ff3333; animation: blink 0.5s infinite; }
@keyframes blink { 50% { opacity: 0.5; } }

.debug-info {
    position: absolute; top: 10px; left: 10px;
    background: rgba(0,0,0,0.7); color: gold;
    padding: 2px 5px; font-size: 10px; border-radius: 4px;
    font-family: monospace; direction: ltr;
}

/* Ù„ÙˆØ¯ÛŒÙ†Ú¯ Ù…Ø¯Ù„ */
#model-loading {
    display: none;
    color: cyan;
    font-size: 12px;
    margin-top: 5px;
}

</style>
</head>

<body>

<header>
    <h2>ğŸ›¡ï¸ Ø³Ø§Ù…Ø§Ù†Ù‡ Ù†Ø¸Ø§Ø±Øª Ù‡ÙˆØ´Ù…Ù†Ø¯</h2>
    <div style="font-size:11px; color:#666;">ØªØ´Ø®ÛŒØµ Ø­Ø±Ú©Øª + ØªØ´Ø®ÛŒØµ Ø§Ù†Ø³Ø§Ù† (AI)</div>
</header>

<video id="video" autoplay playsinline muted></video>

<div class="container">

    <!-- ================= Ù¾Ù†Ù„ Ø¬Ø¯ÛŒØ¯: Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ Ø§Ù†Ø³Ø§Ù† ================= -->
    <div class="panel" id="panel-human">
        <span class="panel-title" style="color:#ff3333;">ğŸ¤– Ø´Ú©Ø§Ø±Ú†ÛŒ Ø§Ù†Ø³Ø§Ù† (AI Detect)</span>
        <p class="panel-desc">ÙÙ‚Ø· Ø±ÙˆÛŒ Ø§Ù†Ø³Ø§Ù† Ø¢Ú˜ÛŒØ± Ù…ÛŒâ€ŒÚ©Ø´Ø¯. Ø¹Ú©Ø³ ÙˆØ§Ø¶Ø­ Ú†Ù‡Ø±Ù‡ Ø±Ø§ Ø¬Ø¯Ø§ Ù…ÛŒâ€ŒÚ©Ù†Ø¯.</p>
        
        <div id="model-loading">â³ Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù…ØºØ² Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ...</div>

        <div class="split-view">
            <!-- Ø³Ù…Øª Ø±Ø§Ø³Øª: ØªØµÙˆÛŒØ± ÙˆØ§Ø¶Ø­ -->
            <div class="view-box">
                <span class="view-label">ğŸ“¸ Ø¨Ù‡ØªØ±ÛŒÙ† Ø´Ú©Ø§Ø± (Ú†Ù‡Ø±Ù‡/Ø¨Ø¯Ù†)</span>
                <img id="best-shot-img" class="captured-image" src="" alt="Ù‡Ù†ÙˆØ² Ø´Ù†Ø§Ø³Ø§ÛŒÛŒ Ù†Ø´Ø¯Ù‡">
                <div style="font-size:10px; color:gold; margin-top:2px;" id="confidence-score">W: 0%</div>
            </div>

            <!-- Ø³Ù…Øª Ú†Ù¾: Ø¯ÙˆØ±Ø¨ÛŒÙ† Ø²Ù†Ø¯Ù‡ -->
            <div class="view-box">
                <span class="view-label">ğŸ‘ï¸ Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø²Ù†Ø¯Ù‡</span>
                <canvas id="canvas-ai"></canvas>
            </div>
        </div>

        <div class="status" id="status-ai">Ø®Ø§Ù…ÙˆØ´</div>

        <div class="btn-row">
            <button class="btn-start" onclick="startHumanDetection()">Ø´Ø±ÙˆØ¹ Ù‡ÙˆØ´Ù…Ù†Ø¯</button>
            <button class="btn-stop" onclick="stopSystem()">ØªÙˆÙ‚Ù</button>
        </div>
    </div>
    <!-- ============================================================ -->


    <!-- Ù¾Ù†Ù„ Û±: Ø­Ø³Ø§Ø³ÛŒØª Ø¨Ø§Ù„Ø§ -->
    <div class="panel" id="panel-sensitive">
        <span class="panel-title">ğŸ‘ï¸ Ø­Ø³Ø§Ø³ÛŒØª Ø­Ø¯Ø§Ú©Ø«Ø±ÛŒ (Ù¾ÛŒÚ©Ø³Ù„)</span>
        <div style="position:relative;">
            <canvas id="canvas1"></canvas>
            <div class="debug-info" id="debug1">0</div>
        </div>
        <div class="status" id="status1">Ø®Ø§Ù…ÙˆØ´</div>
        <div class="btn-row">
            <button class="btn-start" onclick="startMotion('sensitive')">ÙØ¹Ø§Ù„</button>
            <button class="btn-stop" onclick="stopSystem()">ØªÙˆÙ‚Ù</button>
        </div>
    </div>

    <!-- Ù¾Ù†Ù„ Û²: Ú¯Ø±Ø¨Ù‡/Ø­ÛŒÙˆØ§Ù†Ø§Øª -->
    <div class="panel" id="panel-cat">
        <span class="panel-title">ğŸ± Ø­Ø§Ù„Øª Ø­ÛŒÙˆØ§Ù†Ø§Øª (Ù…ØªÙˆØ³Ø·)</span>
        <div style="position:relative;">
            <canvas id="canvas2"></canvas>
            <div class="debug-info" id="debug2">0</div>
        </div>
        <div class="status" id="status2">Ø®Ø§Ù…ÙˆØ´</div>
        <div class="btn-row">
            <button class="btn-start" onclick="startMotion('cat')">ÙØ¹Ø§Ù„</button>
            <button class="btn-stop" onclick="stopSystem()">ØªÙˆÙ‚Ù</button>
        </div>
    </div>

    <!-- Ù¾Ù†Ù„ Û³: Ø¯Ø³ØªÛŒ -->
    <div class="panel" id="panel-custom">
        <span class="panel-title">ğŸ›ï¸ ØªÙ†Ø¸ÛŒÙ… Ø¯Ø³ØªÛŒ Ø­Ø³Ø§Ø³ÛŒØª</span>
        <div class="slider-container">
            <input type="range" id="sensitivitySlider" min="100" max="15000" step="100" value="3000" oninput="document.getElementById('sliderVal').innerText=this.value">
            <div style="font-size:10px; color:#fff;">Ø¢Ø³ØªØ§Ù†Ù‡: <span id="sliderVal">3000</span></div>
        </div>
        <div style="position:relative;">
            <canvas id="canvas3"></canvas>
            <div class="debug-info" id="debug3">0</div>
        </div>
        <div class="status" id="status3">Ø®Ø§Ù…ÙˆØ´</div>
        <div class="btn-row">
            <button class="btn-start" onclick="startMotion('custom')">ÙØ¹Ø§Ù„</button>
            <button class="btn-stop" onclick="stopSystem()">ØªÙˆÙ‚Ù</button>
        </div>
    </div>

</div>

<script>
// --- Ù…ØªØºÛŒØ±Ù‡Ø§ÛŒ Ø³Ø±Ø§Ø³Ø±ÛŒ ---
const video = document.getElementById("video");
let currentStream = null;
let currentMode = null; 
let audioCtx = null;
let oscillator = null;
let requestLoop = null; // Ø¨Ø±Ø§ÛŒ Ú©Ù†Ø³Ù„ Ú©Ø±Ø¯Ù† Ù„ÙˆÙ¾

// Ù…ØªØºÛŒØ±Ù‡Ø§ÛŒ Ø¨Ø®Ø´ Ø­Ø±Ú©ØªÛŒ (Ù‚Ø¯ÛŒÙ…ÛŒ)
let lastFrame = null;

// Ù…ØªØºÛŒØ±Ù‡Ø§ÛŒ Ø¨Ø®Ø´ Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ (Ø¬Ø¯ÛŒØ¯)
let cocoModel = null;
let bestCaptureScore = 0; // Ø¨Ø±Ø§ÛŒ Ø°Ø®ÛŒØ±Ù‡ Ø§Ù…ØªÛŒØ§Ø² Ø¨Ù‡ØªØ±ÛŒÙ† Ø¹Ú©Ø³

// --- ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø­Ø±Ú©ØªÛŒ ---
const CONFIG = {
    sensitive: { thresh: 600, skip: 4, freq: 1200, type: 'sine', cvs: 'canvas1', pnl: 'panel-sensitive', sts: 'status1', dbg: 'debug1', w: 64, h: 48 },
    cat:       { thresh: 2200, skip: 4, freq: 600, type: 'square', cvs: 'canvas2', pnl: 'panel-cat', sts: 'status2', dbg: 'debug2', w: 64, h: 48 },
    custom:    { thresh: 3000, skip: 4, freq: 300, type: 'sawtooth', cvs: 'canvas3', pnl: 'panel-custom', sts: 'status3', dbg: 'debug3', w: 64, h: 48 }
};

// --- ØµØ¯Ø§ (Ø¢Ú˜ÛŒØ±) ---
function startAlarm(isHuman) {
    if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    if (oscillator) return; 

    oscillator = audioCtx.createOscillator();
    const gainNode = audioCtx.createGain();
    
    if (isHuman) {
        // ØµØ¯Ø§ÛŒ Ù…Ø®ØµÙˆØµ Ø§Ù†Ø³Ø§Ù†: Ø¨Ù… Ùˆ Ù…Ù…ØªØ¯ Ùˆ ØªØ±Ø³Ù†Ø§Ú©
        oscillator.type = 'sawtooth';
        oscillator.frequency.value = 100; 
        // Ø§ÙÚ©Øª ÙˆÛŒØ¨Ø±Ù‡
        const lfo = audioCtx.createOscillator();
        lfo.type = 'sine';
        lfo.frequency.value = 10;
        const lfoGain = audioCtx.createGain();
        lfoGain.gain.value = 500;
        lfo.connect(lfoGain);
        lfoGain.connect(oscillator.frequency);
        lfo.start();
    } else {
        // ØµØ¯Ø§ÛŒ Ù…Ø¹Ù…ÙˆÙ„ÛŒ Ø¨Ø±Ø§ÛŒ Ø­Ø§Ù„Øªâ€ŒÙ‡Ø§ÛŒ Ø¯ÛŒÚ¯Ø±
        const set = CONFIG[currentMode];
        oscillator.type = set ? set.type : 'square';
        oscillator.frequency.value = set ? set.freq : 500;
    }
    
    gainNode.gain.value = 0.2;
    oscillator.connect(gainNode);
    gainNode.connect(audioCtx.destination);
    oscillator.start();
}

function stopAlarm() {
    if (oscillator) {
        try { oscillator.stop(); oscillator.disconnect(); } catch(e){}
        oscillator = null;
    }
}

// --- Ù…Ø¯ÛŒØ±ÛŒØª Ø¯ÙˆØ±Ø¨ÛŒÙ† ---
async function initCamera() {
    if (!currentStream) {
        currentStream = await navigator.mediaDevices.getUserMedia({
            video: { facingMode: "environment", width: {ideal: 640}, height: {ideal: 480} },
            audio: false
        });
        video.srcObject = currentStream;
        await new Promise(r => video.onloadedmetadata = r);
        video.play();
    }
}

function stopSystem() {
    stopAlarm();
    currentMode = null;
    if (requestLoop) cancelAnimationFrame(requestLoop);
    
    // Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† ÙˆØ¶Ø¹ÛŒØªâ€ŒÙ‡Ø§
    document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
    document.querySelectorAll('.status').forEach(s => { s.innerText = "Ø®Ø§Ù…ÙˆØ´"; s.className = "status"; });
    
    // Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ú©Ø§Ù†ÙˆØ§Ø³â€ŒÙ‡Ø§
    document.querySelectorAll('canvas').forEach(c => {
        const ctx = c.getContext('2d');
        ctx.clearRect(0,0,c.width,c.height);
    });
}

function activatePanel(id, statusId, msg) {
    document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    document.getElementById(statusId).innerText = msg;
}

// ======================================================
// 1. Ù…Ù†Ø·Ù‚ ØªØ´Ø®ÛŒØµ Ø­Ø±Ú©Øª (Motion Detection - Ø±ÙˆØ´ Ù‚Ø¯ÛŒÙ…ÛŒ)
// ======================================================
async function startMotion(mode) {
    stopSystem();
    currentMode = mode;
    await initCamera();
    activatePanel(CONFIG[mode].pnl, CONFIG[mode].sts, "ğŸŸ¢ ÙØ¹Ø§Ù„ - Ø¢Ù†Ø§Ù„ÛŒØ² Ù¾ÛŒÚ©Ø³Ù„ÛŒ");
    lastFrame = null;
    
    // Ø¢Ù¾Ø¯ÛŒØª ØªØ±Ø´ÙˆÙ„Ø¯ Ú©Ø§Ø³ØªÙˆÙ…
    if (mode === 'custom') CONFIG.custom.thresh = parseInt(document.getElementById('sensitivitySlider').value);

    processMotionFrame();
}

function processMotionFrame() {
    if (!currentMode || ['sensitive','cat','custom'].indexOf(currentMode) === -1) return;
    requestLoop = requestAnimationFrame(processMotionFrame);

    const set = CONFIG[currentMode];
    const cvs = document.getElementById(set.cvs);
    const ctx = cvs.getContext('2d');

    if (cvs.width !== video.videoWidth) { cvs.width = video.videoWidth; cvs.height = video.videoHeight; }
    
    ctx.drawImage(video, 0, 0, cvs.width, cvs.height);

    // Ú©ÙˆÚ†Ú© Ø³Ø§Ø²ÛŒ Ø¨Ø±Ø§ÛŒ Ù¾Ø±Ø¯Ø§Ø²Ø´
    const tmpCvs = document.createElement('canvas');
    tmpCvs.width = set.w; tmpCvs.height = set.h;
    const tctx = tmpCvs.getContext('2d');
    tctx.drawImage(video, 0, 0, set.w, set.h);
    const frame = tctx.getImageData(0,0,set.w,set.h);

    if (lastFrame) {
        let score = 0;
        const d = frame.data; const ld = lastFrame.data;
        for (let i=0; i<d.length; i+=4*set.skip) {
            if (Math.abs(d[i+1]-ld[i+1]) > 20) score += Math.abs(d[i+1]-ld[i+1]);
        }

        const debugEl = document.getElementById(set.dbg);
        if(debugEl) debugEl.innerText = score;

        if (score > set.thresh) {
            document.getElementById(set.sts).innerText = "ğŸš¨ Ø­Ø±Ú©Øª!";
            document.getElementById(set.sts).classList.add('alert');
            startAlarm(false);
            ctx.fillStyle = "rgba(255,0,0,0.3)"; ctx.fillRect(0,0,cvs.width,cvs.height);
        } else {
            document.getElementById(set.sts).innerText = "ğŸŸ¢ Ø§Ù…Ù†";
            document.getElementById(set.sts).classList.remove('alert');
            stopAlarm();
        }
    }
    lastFrame = frame;
}

// ======================================================
// 2. Ù…Ù†Ø·Ù‚ ØªØ´Ø®ÛŒØµ Ø§Ù†Ø³Ø§Ù† (AI Human Detection - Ø¬Ø¯ÛŒØ¯)
// ======================================================
async function startHumanDetection() {
    stopSystem();
    currentMode = 'human';
    activatePanel('panel-human', 'status-ai', "â³ Ø±Ø§Ù‡ Ø§Ù†Ø¯Ø§Ø²ÛŒ Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ...");
    
    // Ù†Ù…Ø§ÛŒØ´ Ù„ÙˆØ¯ÛŒÙ†Ú¯
    const loadingEl = document.getElementById('model-loading');
    loadingEl.style.display = 'block';

    try {
        await initCamera();
        
        // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù…Ø¯Ù„ ÙÙ‚Ø· Ø§Ú¯Ø± Ù‚Ø¨Ù„Ø§Ù‹ Ù„ÙˆØ¯ Ù†Ø´Ø¯Ù‡ Ø¨Ø§Ø´Ø¯
        if (!cocoModel) {
            // Ù…Ø¯Ù„ Ù„Ø§ÛŒØª Ø¨Ø±Ø§ÛŒ Ø³Ø±Ø¹Øª Ø¨ÛŒØ´ØªØ± Ø±ÙˆÛŒ Ù…ÙˆØ¨Ø§ÛŒÙ„
            cocoModel = await cocoSsd.load({ base: 'lite_mobilenet_v2' });
        }
        
        loadingEl.style.display = 'none';
        activatePanel('panel-human', 'status-ai', "ğŸŸ¢ Ø±Ø§Ø¯Ø§Ø± Ø§Ù†Ø³Ø§Ù† ÙØ¹Ø§Ù„ Ø´Ø¯");
        
        // Ø±ÛŒØ³Øª Ú©Ø±Ø¯Ù† Ø¨Ù‡ØªØ±ÛŒÙ† Ø¹Ú©Ø³ Ù‚Ø¨Ù„ÛŒ
        bestCaptureScore = 0;
        document.getElementById('best-shot-img').src = "";
        document.getElementById('best-shot-img').classList.remove('has-photo');
        document.getElementById('confidence-score').innerText = "Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø±...";

        processHumanFrame();

    } catch (e) {
        console.error(e);
        document.getElementById('status-ai').innerText = "âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ";
        loadingEl.style.display = 'none';
    }
}

async function processHumanFrame() {
    if (currentMode !== 'human') return;
    
    // Ù¾Ø±Ø¯Ø§Ø²Ø´ ÙØ±ÛŒÙ… Ø¨Ø¹Ø¯ÛŒ
    requestLoop = requestAnimationFrame(processHumanFrame);

    const cvs = document.getElementById('canvas-ai');
    const ctx = cvs.getContext('2d');
    
    if (cvs.width !== video.videoWidth) { cvs.width = video.videoWidth; cvs.height = video.videoHeight; }
    
    // Ø±Ø³Ù… ØªØµÙˆÛŒØ± Ø®Ø§Ù…
    ctx.drawImage(video, 0, 0, cvs.width, cvs.height);

    // ØªØ´Ø®ÛŒØµ Ø§Ø´ÛŒØ§Ø¡
    const predictions = await cocoModel.detect(video);
    
    let personFound = false;

    predictions.forEach(prediction => {
        // ÙÙ‚Ø· Ø§Ú¯Ø± 'person' Ø¨ÙˆØ¯
        if (prediction.class === 'person') {
            personFound = true;
            
            const [x, y, width, height] = prediction.bbox;
            const score = prediction.score; // Ø¯Ø±ØµØ¯ Ø§Ø·Ù…ÛŒÙ†Ø§Ù† (0 ØªØ§ 1)

            // Ø±Ø³Ù… Ú©Ø§Ø¯Ø± Ø¯ÙˆØ± Ø§Ù†Ø³Ø§Ù†
            ctx.strokeStyle = "#00ff00";
            ctx.lineWidth = 4;
            ctx.strokeRect(x, y, width, height);
            
            ctx.font = "18px Arial";
            ctx.fillStyle = "#00ff00";
            ctx.fillText(`HUMAN ${(score*100).toFixed(0)}%`, x, y > 10 ? y - 5 : 10);

            // --- Ø§Ù„Ú¯ÙˆØ±ÛŒØªÙ… Ø§Ù†ØªØ®Ø§Ø¨ Ø¨Ù‡ØªØ±ÛŒÙ† Ø¹Ú©Ø³ ---
            // ÙØ±Ù…ÙˆÙ„ Ø§Ù…ØªÛŒØ§Ø²: (Ø§Ù†Ø¯Ø§Ø²Ù‡ ØªØµÙˆÛŒØ±) * (Ø¯Ù‚Øª ØªØ´Ø®ÛŒØµ)
            // Ø¹Ú©Ø³â€ŒÙ‡Ø§ÛŒ Ø¨Ø²Ø±Ú¯ØªØ± Ùˆ Ù…Ø·Ù…Ø¦Ù†â€ŒØªØ± Ø§Ù…ØªÛŒØ§Ø² Ø¨ÛŒØ´ØªØ±ÛŒ Ù…ÛŒâ€ŒÚ¯ÛŒØ±Ù†Ø¯
            const clarityScore = (width * height) * score;

            if (clarityScore > bestCaptureScore) {
                bestCaptureScore = clarityScore;
                
                // Ø¨Ø±Ø´ Ø²Ø¯Ù† (Crop) ÙÙ‚Ø· Ù…Ø­Ø¯ÙˆØ¯Ù‡ Ø§Ù†Ø³Ø§Ù† Ø¨Ø±Ø§ÛŒ Ø¹Ú©Ø³ Ø³Ù…Øª Ø±Ø§Ø³Øª
                // Ú©Ù…ÛŒ Ø­Ø§Ø´ÛŒÙ‡ (Padding) Ø§Ø¶Ø§ÙÙ‡ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ… Ú©Ù‡ Ø¹Ú©Ø³ Ø²ÛŒØ¨Ø§ØªØ± Ø´ÙˆØ¯
                const padding = 20;
                const sx = Math.max(0, x - padding);
                const sy = Math.max(0, y - padding);
                const sw = Math.min(cvs.width - sx, width + (padding*2));
                const sh = Math.min(cvs.height - sy, height + (padding*2));

                const captureCanvas = document.createElement('canvas');
                captureCanvas.width = sw;
                captureCanvas.height = sh;
                const cctx = captureCanvas.getContext('2d');
                
                // Ú©Ø´ÛŒØ¯Ù† Ø¢Ù† Ø¨Ø®Ø´ Ø§Ø² ØªØµÙˆÛŒØ± Ø±ÙˆÛŒ Ú©Ø§Ù†ÙˆØ§Ø³ Ù…ÙˆÙ‚Øª
                cctx.drawImage(video, sx, sy, sw, sh, 0, 0, sw, sh);
                
                // ØªØ¨Ø¯ÛŒÙ„ Ø¨Ù‡ Ø¹Ú©Ø³ Ùˆ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø± Ù¾Ù†Ù„ Ø³Ù…Øª Ø±Ø§Ø³Øª
                const imgData = captureCanvas.toDataURL('image/jpeg');
                const imgEl = document.getElementById('best-shot-img');
                imgEl.src = imgData;
                imgEl.classList.add('has-photo');
                
                document.getElementById('confidence-score').innerText = `ÙˆØ¶ÙˆØ­: ${Math.floor(clarityScore/100)} Ø§Ù…ØªÛŒØ§Ø²`;
            }
        }
    });

    if (personFound) {
        document.getElementById('status-ai').innerText = "ğŸš¨ Ø§Ù†Ø³Ø§Ù† Ø´Ù†Ø§Ø³Ø§ÛŒÛŒ Ø´Ø¯!";
        document.getElementById('status-ai').classList.add('alert');
        startAlarm(true);
    } else {
        document.getElementById('status-ai').innerText = "ğŸŸ¢ Ù…Ø­ÛŒØ· Ø§Ù…Ù† (Ø¬Ø³ØªØ¬ÙˆÛŒ Ø§Ù†Ø³Ø§Ù†...)";
        document.getElementById('status-ai').classList.remove('alert');
        stopAlarm();
    }
}

</script>

</body>
</html>
