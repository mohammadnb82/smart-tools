<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Ø³ÛŒØ³ØªÙ… Ø­ÙØ§Ø¸ØªÛŒ Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ</title>

<style>
body {
    margin: 0;
    background: #0f0f12;
    color: #00ffcc;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    text-align: center;
    padding-bottom: 80px;
}

header {
    padding: 20px;
    background: linear-gradient(180deg, #000 0%, #1a1a1a 100%);
    border-bottom: 1px solid #00ffcc;
    margin-bottom: 20px;
    box-shadow: 0 0 20px rgba(0, 255, 204, 0.1);
}

h2 { margin: 0; font-size: 22px; }

.container {
    display: flex;
    flex-direction: column;
    gap: 25px;
    padding: 15px;
    max-width: 600px;
    margin: 0 auto;
}

.panel {
    border: 1px solid #333;
    background: #18181b;
    padding: 20px;
    border-radius: 12px;
    position: relative;
    transition: all 0.3s ease;
    box-shadow: 0 4px 6px rgba(0,0,0,0.3);
}

.panel.active {
    border-color: #00ffcc;
    box-shadow: 0 0 20px rgba(0, 255, 204, 0.15);
    background: #1e1e24;
}

.panel-title {
    font-weight: bold;
    font-size: 18px;
    display: block;
    color: #fff;
    margin-bottom: 5px;
}

.panel-desc {
    font-size: 13px;
    color: #888;
    margin-bottom: 15px;
}

/* Ø§Ø³Ù„Ø§ÛŒØ¯Ø± ØªÙ†Ø¸ÛŒÙ… Ø­Ø³Ø§Ø³ÛŒØª */
.slider-container {
    margin: 15px 0;
    text-align: center;
}
input[type=range] {
    width: 100%;
    accent-color: #00ffcc;
    cursor: pointer;
}
.range-labels {
    display: flex;
    justify-content: space-between;
    font-size: 11px;
    color: #666;
    margin-top: 5px;
}

/* ÙˆÛŒØ¯ÛŒÙˆ Ù…Ø®ÙÛŒ */
video {
    position: absolute;
    top: 0;
    left: 0;
    width: 1px;
    height: 1px;
    opacity: 0;
    z-index: -1;
    pointer-events: none;
}

canvas {
    width: 100%;
    height: auto;
    border: 2px solid #333;
    background: #000;
    border-radius: 8px;
    display: block;
}

.btn-row {
    margin-top: 20px;
    display: flex;
    justify-content: center;
    gap: 12px;
}

button {
    border: none;
    padding: 14px 0;
    font-size: 15px;
    border-radius: 8px;
    cursor: pointer;
    font-weight: bold;
    flex: 1; 
    transition: transform 0.1s;
}

button:active { transform: scale(0.98); }

.btn-start { background: linear-gradient(45deg, #008866, #00cc99); color: #fff; box-shadow: 0 4px 10px rgba(0, 204, 153, 0.3); }
.btn-stop { background: linear-gradient(45deg, #882222, #cc3333); color: #fff; box-shadow: 0 4px 10px rgba(204, 51, 51, 0.3); }

.status {
    margin-top: 15px;
    font-size: 14px;
    color: #666;
    font-weight: bold;
}

.debug-info {
    font-family: 'Courier New', monospace;
    font-size: 13px;
    color: #ffcc00;
    background: rgba(0,0,0,0.5);
    padding: 4px 8px;
    border-radius: 4px;
    position: absolute;
    top: 20px;
    left: 20px;
    direction: ltr;
}

.alert {
    color: #ff3333;
    animation: pulse 0.5s infinite;
}

@keyframes pulse {
    0% { opacity: 1; transform: scale(1); }
    50% { opacity: 0.7; transform: scale(1.02); }
    100% { opacity: 1; transform: scale(1); }
}

</style>
</head>

<body>

<header>
    <h2>ğŸ›¡ï¸ Ø³ÛŒØ³ØªÙ… Ø­ÙØ§Ø¸ØªÛŒ (Ù†Ø³Ø®Ù‡ Û³)</h2>
    <div style="font-size:11px; color:#aaa; margin-top:5px;">Ø¨Ø§ Ù‚Ø§Ø¨Ù„ÛŒØª ØªÙ†Ø¸ÛŒÙ… Ø¯Ø³ØªÛŒ</div>
</header>

<video id="video" autoplay playsinline muted></video>

<div class="container">

    <!-- Ù¾Ù†Ù„ Û±: Ø­Ø³Ø§Ø³ -->
    <div class="panel" id="panel-sensitive">
        <span class="panel-title">ğŸ‘ï¸ Ø­Ø³Ø§Ø³ÛŒØª Ø­Ø¯Ø§Ú©Ø«Ø±ÛŒ</span>
        <p class="panel-desc">ÙˆØ§Ú©Ù†Ø´ Ø¨Ù‡ Ú©ÙˆÚ†Ú©ØªØ±ÛŒÙ† Ø­Ø±Ú©Ø§Øª (Ø­Ø´Ø±Ø§ØªØŒ Ø¨Ø±Ú¯ Ø¯Ø±Ø®Øª).</p>
        
        <div style="position:relative;">
            <canvas id="canvas1"></canvas>
            <div class="debug-info" id="debug1">Score: 0</div>
        </div>
        <div class="status" id="status1">ØºÛŒØ±ÙØ¹Ø§Ù„</div>
        
        <div class="btn-row">
            <button class="btn-start" onclick="startSystem('sensitive')">ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ</button>
            <button class="btn-stop" onclick="stopSystem()">ØªÙˆÙ‚Ù</button>
        </div>
    </div>

    <!-- Ù¾Ù†Ù„ Û²: Ú¯Ø±Ø¨Ù‡ -->
    <div class="panel" id="panel-cat">
        <span class="panel-title">ğŸ± Ø­Ø§Ù„Øª Ø­ÛŒÙˆØ§Ù†Ø§Øª Ø®Ø§Ù†Ú¯ÛŒ (Ú¯Ø±Ø¨Ù‡)</span>
        <p class="panel-desc">Ø§Ø´ÛŒØ§Ø¡ Ú©ÙˆÚ†Ú©ØªØ± Ø§Ø² Ú¯Ø±Ø¨Ù‡ (Ø¯Ø± ÙØ§ØµÙ„Ù‡ Ø¯ÙˆØ±) Ø±Ø§ Ù†Ø§Ø¯ÛŒØ¯Ù‡ Ù…ÛŒâ€ŒÚ¯ÛŒØ±Ø¯.</p>
        
        <div style="position:relative;">
            <canvas id="canvas2"></canvas>
            <div class="debug-info" id="debug2">Score: 0</div>
        </div>
        <div class="status" id="status2">ØºÛŒØ±ÙØ¹Ø§Ù„</div>
        
        <div class="btn-row">
            <button class="btn-start" onclick="startSystem('cat')">ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ</button>
            <button class="btn-stop" onclick="stopSystem()">ØªÙˆÙ‚Ù</button>
        </div>
    </div>

    <!-- Ù¾Ù†Ù„ Û³: Ø¯Ø³ØªÛŒ -->
    <div class="panel" id="panel-custom">
        <span class="panel-title">ğŸ›ï¸ ØªÙ†Ø¸ÛŒÙ… Ø¯Ø³ØªÛŒ (Ù¾ÛŒØ´Ø±ÙØªÙ‡)</span>
        <p class="panel-desc">Ù…ÛŒØ²Ø§Ù† Ø­Ø³Ø§Ø³ÛŒØª Ø±Ø§ Ø®ÙˆØ¯ØªØ§Ù† Ø¨Ø§ Ø§Ø³Ù„Ø§ÛŒØ¯Ø± Ø²ÛŒØ± ØªÙ†Ø¸ÛŒÙ… Ú©Ù†ÛŒØ¯.</p>
        
        <!-- Ø§Ø³Ù„Ø§ÛŒØ¯Ø± ØªÙ†Ø¸ÛŒÙ… -->
        <div class="slider-container">
            <input type="range" id="sensitivitySlider" min="100" max="15000" step="100" value="3000" oninput="updateSliderDisplay(this.value)">
            <div class="range-labels">
                <span>Ø®ÛŒÙ„ÛŒ Ø­Ø³Ø§Ø³ (Ø­Ø±Ú©Øª Ø±ÛŒØ²)</span>
                <span>Ø³Ù†Ú¯ÛŒÙ† (Ø§Ù†Ø³Ø§Ù†/Ù…Ø§Ø´ÛŒÙ†)</span>
            </div>
            <div style="margin-top:5px; color:#00ffcc;">Ø­Ø¯ Ø¢Ø³ØªØ§Ù†Ù‡ ÙØ¹Ù„ÛŒ: <span id="sliderValueDisplay">3000</span></div>
        </div>

        <div style="position:relative;">
            <canvas id="canvas3"></canvas>
            <div class="debug-info" id="debug3">Score: 0</div>
        </div>
        <div class="status" id="status3">ØºÛŒØ±ÙØ¹Ø§Ù„</div>
        
        <div class="btn-row">
            <button class="btn-start" onclick="startSystem('custom')">Ø´Ø±ÙˆØ¹ ØªØ³Øª</button>
            <button class="btn-stop" onclick="stopSystem()">ØªÙˆÙ‚Ù</button>
        </div>
    </div>

</div>

<script>
const video = document.getElementById("video");
let currentStream = null;
let currentMode = null; 
let audioCtx = null;
let oscillator = null;
let lastFrame = null;
let analysisLoop = null;

// ØªÙ†Ø¸ÛŒÙ…Ø§Øª
const CONFIG = {
    sensitive: {
        threshold: 600,       // Ø¹Ø¯Ø¯ Ú©Ù… = Ø­Ø³Ø§Ø³ÛŒØª Ø¨Ø§Ù„Ø§ (Ø¨Ø±Ø§ÛŒ Ø­Ø´Ø±Ø§Øª/Ø¨Ø±Ú¯)
        pixelSkip: 4,         
        soundFreq: 1200,     // ØµØ¯Ø§ÛŒ Ø²ÛŒØ± (Ø¨ÛŒÙ¾ Ø¨ÛŒÙ¾ Ø³Ø±ÛŒØ¹)
        soundType: 'sine',
        canvasId: 'canvas1',
        panelId: 'panel-sensitive',
        statusId: 'status1',
        debugId: 'debug1',
        resW: 64, resH: 48
    },
    cat: {
        threshold: 2200,      // ØªÙ†Ø¸ÛŒÙ… Ø´Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ Ú¯Ø±Ø¨Ù‡ (Ù†Ù‡ Ø®ÛŒÙ„ÛŒ Ø­Ø³Ø§Ø³ØŒ Ù†Ù‡ Ø®ÛŒÙ„ÛŒ Ø³Ù†Ú¯ÛŒÙ†)
        pixelSkip: 4,         
        soundFreq: 600,       // ØµØ¯Ø§ÛŒ Ù…ØªÙˆØ³Ø·
        soundType: 'square',
        canvasId: 'canvas2',
        panelId: 'panel-cat',
        statusId: 'status2',
        debugId: 'debug2',
        resW: 64, resH: 48
    },
    custom: {
        threshold: 3000,      // Ù…Ù‚Ø¯Ø§Ø± Ø§ÙˆÙ„ÛŒÙ‡ (Ø§Ø² Ø§Ø³Ù„Ø§ÛŒØ¯Ø± Ø®ÙˆØ§Ù†Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯)
        pixelSkip: 4,
        soundFreq: 300,       // ØµØ¯Ø§ÛŒ Ø¨Ù… Ù‡Ø´Ø¯Ø§Ø±
        soundType: 'sawtooth',
        canvasId: 'canvas3',
        panelId: 'panel-custom',
        statusId: 'status3',
        debugId: 'debug3',
        resW: 64, resH: 48
    }
};

function updateSliderDisplay(val) {
    document.getElementById('sliderValueDisplay').innerText = val;
    // Ø§Ú¯Ø± Ø¯Ø± Ø­Ø§Ù„ Ø§Ø¬Ø±Ø§ÛŒ Ø­Ø§Ù„Øª Ú©Ø§Ø³ØªÙˆÙ… Ù‡Ø³ØªÛŒÙ…ØŒ Ù…Ù‚Ø¯Ø§Ø± Ø±Ø§ Ø±ÛŒÙ„â€ŒØªØ§ÛŒÙ… Ø¢Ù¾Ø¯ÛŒØª Ú©Ù†
    if(currentMode === 'custom') {
        CONFIG.custom.threshold = parseInt(val);
    }
}

// --- ØªÙˆØ§Ø¨Ø¹ ØµØ¯Ø§ ---
function startAlarm(type) {
    if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    if (oscillator) return; 

    oscillator = audioCtx.createOscillator();
    const gainNode = audioCtx.createGain();
    
    const settings = CONFIG[type];
    oscillator.type = settings.soundType;
    oscillator.frequency.value = settings.soundFreq;
    
    // Ù…Ø¯ÙˆÙ„Ø§Ø³ÛŒÙˆÙ† ØµØ¯Ø§ Ø¨Ø±Ø§ÛŒ ØªØ±Ø³Ù†Ø§Ú©â€ŒØªØ± Ø´Ø¯Ù† Ø¢Ù„Ø§Ø±Ù…
    if (type === 'cat' || type === 'custom') {
        oscillator.frequency.setValueAtTime(settings.soundFreq, audioCtx.currentTime);
        oscillator.frequency.linearRampToValueAtTime(settings.soundFreq - 100, audioCtx.currentTime + 0.1);
    }

    gainNode.gain.value = 0.2; 
    
    oscillator.connect(gainNode);
    gainNode.connect(audioCtx.destination);
    oscillator.start();
}

function stopAlarm() {
    if (oscillator) {
        try {
            oscillator.stop();
            oscillator.disconnect();
        } catch(e) {}
        oscillator = null;
    }
}

// --- Ù…Ø¯ÛŒØ±ÛŒØª Ø³ÛŒØ³ØªÙ… ---
async function startSystem(mode) {
    if (currentMode) stopSystem();

    currentMode = mode;
    const settings = CONFIG[mode];
    
    // Ø®ÙˆØ§Ù†Ø¯Ù† Ù…Ù‚Ø¯Ø§Ø± Ø§Ø³Ù„Ø§ÛŒØ¯Ø± Ø§Ú¯Ø± Ø­Ø§Ù„Øª Ø¯Ø³ØªÛŒ Ø¨Ø§Ø´Ø¯
    if (mode === 'custom') {
        const sliderVal = document.getElementById('sensitivitySlider').value;
        settings.threshold = parseInt(sliderVal);
    }

    document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
    document.getElementById(settings.panelId).classList.add('active');
    updateStatus("...Ø¯Ø± Ø­Ø§Ù„ Ú©Ø§Ù„ÛŒØ¨Ø±Ø§Ø³ÛŒÙˆÙ† Ø¯ÙˆØ±Ø¨ÛŒÙ†...", false);

    try {
        if (!currentStream) {
            currentStream = await navigator.mediaDevices.getUserMedia({
                video: { facingMode: "environment", width: 640, height: 480 },
                audio: false
            });
            video.srcObject = currentStream;
            await new Promise(r => video.onloadedmetadata = r);
            video.play();
        }

        lastFrame = null;
        updateStatus("ğŸŸ¢ ÙØ¹Ø§Ù„ - Ø¯Ø± Ø­Ø§Ù„ Ù†Ú¯Ù‡Ø¨Ø§Ù†ÛŒ", false);
        detectMotion();

    } catch (err) {
        console.error(err);
        updateStatus("âŒ Ø®Ø·Ø§: Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ø¯ÙˆØ±Ø¨ÛŒÙ† Ù…Ù…Ú©Ù† Ù†ÛŒØ³Øª", false);
        currentMode = null;
    }
}

function stopSystem() {
    if (!currentMode) return;
    
    stopAlarm();
    
    document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
    updateStatus("ØºÛŒØ±ÙØ¹Ø§Ù„", false);
    
    const settings = CONFIG[currentMode];
    const canvas = document.getElementById(settings.canvasId);
    const ctx = canvas.getContext("2d");
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    // Ø±ÛŒØ³Øª Ù…ØªÙ†
    document.getElementById(settings.debugId).innerText = "Score: 0";

    currentMode = null;
    cancelAnimationFrame(analysisLoop);
}

function updateStatus(text, isAlert) {
    if (!currentMode) return;
    const el = document.getElementById(CONFIG[currentMode].statusId);
    el.textContent = text;
    el.className = isAlert ? "status alert" : "status";
}

// --- Ù‡Ø³ØªÙ‡ Ù¾Ø±Ø¯Ø§Ø²Ø´ ØªØµÙˆÛŒØ± ---
function detectMotion() {
    if (!currentMode) return;

    analysisLoop = requestAnimationFrame(detectMotion);

    if (video.readyState !== 4 || video.videoWidth === 0) return;

    const settings = CONFIG[currentMode];
    const canvas = document.getElementById(settings.canvasId);
    const ctx = canvas.getContext("2d");

    // ØªÙ†Ø¸ÛŒÙ… Ø³Ø§ÛŒØ² Ú©Ø§Ù†ÙˆØ§Ø³ Ù†Ù…Ø§ÛŒØ´ÛŒ
    if (canvas.width !== video.videoWidth) {
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
    }

    // 1. Ø±Ø³Ù… ØªØµÙˆÛŒØ± Ø²Ù†Ø¯Ù‡
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

    // 2. Ø³Ø§Ø®Øª ØªØµÙˆÛŒØ± Ú©ÙˆÚ†Ú© Ø¨Ø±Ø§ÛŒ Ø¢Ù†Ø§Ù„ÛŒØ²
    const w = settings.resW;
    const h = settings.resH;
    
    const tempCanvas = document.createElement('canvas');
    tempCanvas.width = w;
    tempCanvas.height = h;
    const tctx = tempCanvas.getContext('2d');
    tctx.drawImage(video, 0, 0, w, h);
    
    const frame = tctx.getImageData(0, 0, w, h);

    // 3. Ù…Ù‚Ø§ÛŒØ³Ù‡ Ø¨Ø§ ÙØ±ÛŒÙ… Ù‚Ø¨Ù„ÛŒ
    if (lastFrame) {
        let score = 0;
        const data = frame.data;
        const lastData = lastFrame.data;
        const skip = settings.pixelSkip;

        for (let i = 0; i < data.length; i += 4 * skip) {
            // ÙÙ‚Ø· Ú©Ø§Ù†Ø§Ù„ Ø³Ø¨Ø² Ø±Ø§ Ù…Ù‚Ø§ÛŒØ³Ù‡ Ù…ÛŒÚ©Ù†ÛŒÙ… (Ø¨Ù‡ÛŒÙ†Ù‡)
            const diff = Math.abs(data[i+1] - lastData[i+1]); 
            
            // ÙÛŒÙ„ØªØ± Ù†ÙˆÛŒØ²: ØªØºÛŒÛŒØ±Ø§Øª Ù¾ÛŒÚ©Ø³Ù„ Ø²ÛŒØ± 20 Ø±Ø§ Ù†Ø§Ø¯ÛŒØ¯Ù‡ Ø¨Ú¯ÛŒØ±
            if (diff > 20) { 
                score += diff;
            }
        }

        // Ù†Ù…Ø§ÛŒØ´ Ø§Ù…ØªÛŒØ§Ø² Ø²Ù†Ø¯Ù‡
        const debugEl = document.getElementById(settings.debugId);
        if (debugEl) {
            debugEl.innerText = `Score: ${score} / Limit: ${settings.threshold}`;
            debugEl.style.color = score > settings.threshold ? "#ff3333" : "#ffcc00";
        }

        // ØªØµÙ…ÛŒÙ…â€ŒÚ¯ÛŒØ±ÛŒ Ø¢Ú˜ÛŒØ±
        if (score > settings.threshold) {
            updateStatus("ğŸš¨ ÙˆØ±ÙˆØ¯ ØºÛŒØ±Ù…Ø¬Ø§Ø²!", true);
            startAlarm(currentMode);

            // Ø§ÙÚ©Øª Ø¨ØµØ±ÛŒ Ù‚Ø±Ù…Ø²
            ctx.strokeStyle = "red";
            ctx.lineWidth = 5;
            ctx.strokeRect(10, 10, canvas.width - 20, canvas.height - 20);
            
            ctx.fillStyle = "rgba(255, 0, 0, 0.4)";
            ctx.fillRect(0, 0, canvas.width, canvas.height);
        } else {
            updateStatus("ğŸŸ¢ ÙˆØ¶Ø¹ÛŒØª Ø³ÙÛŒØ¯", false);
            stopAlarm();
        }
    }

    lastFrame = frame;
}
</script>

</body>
</html>
