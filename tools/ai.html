<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Ø³ÛŒØ³ØªÙ… Ø­ÙØ§Ø¸ØªÛŒ Ù‡ÙˆØ´Ù…Ù†Ø¯</title>

<style>
body {
    margin: 0;
    background: #111;
    color: #00ffcc;
    font-family: Tahoma, Arial, sans-serif;
    text-align: center;
    padding-bottom: 50px;
}

header {
    padding: 15px;
    background: #000;
    border-bottom: 2px solid #00ffcc;
    margin-bottom: 20px;
}

.container {
    display: flex;
    flex-direction: column;
    gap: 20px;
    padding: 10px;
}

.panel {
    border: 1px solid #333;
    background: #1a1a1a;
    padding: 15px;
    border-radius: 10px;
    position: relative;
    transition: all 0.3s;
}

.panel.active {
    border-color: #00ffcc;
    box-shadow: 0 0 15px rgba(0, 255, 204, 0.2);
}

.panel-title {
    font-weight: bold;
    font-size: 18px;
    margin-bottom: 5px;
    display: block;
    color: #fff;
}

.panel-desc {
    font-size: 13px;
    color: #aaa;
    margin-bottom: 10px;
}

/* ÙˆÛŒØ¯ÛŒÙˆ Ù…Ø®ÙÛŒ Ø¨Ø±Ø§ÛŒ Ù¾Ø±Ø¯Ø§Ø²Ø´ iOS */
video {
    position: absolute;
    top: 0;
    left: 0;
    width: 1px;
    height: 1px;
    opacity: 0;
    z-index: -1;
    pointer-events: none;
}

canvas {
    width: 100%;
    max-width: 400px;
    height: auto;
    border: 1px solid #444;
    background: #000;
    border-radius: 8px;
    margin-top: 5px;
}

.btn-row {
    margin-top: 15px;
    display: flex;
    justify-content: center;
    gap: 10px;
}

button {
    border: none;
    padding: 12px 0;
    font-size: 14px;
    border-radius: 6px;
    cursor: pointer;
    font-weight: bold;
    flex: 1; 
    max-width: 120px;
}

.btn-start { background: #008866; color: #fff; }
.btn-stop { background: #882222; color: #fff; }
.btn-start:hover { background: #00aa88; }
.btn-stop:hover { background: #aa3333; }

.status {
    margin-top: 10px;
    font-size: 14px;
    color: #888;
    min-height: 20px;
}

.alert {
    color: #ff3333;
    font-weight: bold;
    animation: blink 0.2s infinite alternate;
}

@keyframes blink {
    from { opacity: 1; }
    to { opacity: 0.5; }
}

</style>
</head>

<body>

<header>
    <h2>ğŸ›¡ï¸ Ø³ÛŒØ³ØªÙ… Ø­ÙØ§Ø¸ØªÛŒ Ù‡ÙˆØ´Ù…Ù†Ø¯</h2>
    <p style="color:#aaa;font-size:12px">Ø¨Ø¯ÙˆÙ† Ù†ÛŒØ§Ø² Ø¨Ù‡ Ø§ÛŒÙ†ØªØ±Ù†Øª (Ù†Ø³Ø®Ù‡ iOS)</p>
</header>

<!-- ÙˆÛŒØ¯ÛŒÙˆ Ø³ÙˆØ±Ø³ Ø§ØµÙ„ÛŒ (Ù…Ø´ØªØ±Ú© Ùˆ Ù…Ø®ÙÛŒ) -->
<video id="video" autoplay playsinline muted></video>

<div class="container">

    <!-- Ù¾Ù†Ù„ Û±: Ø­Ø³Ø§Ø³ -->
    <div class="panel" id="panel-sensitive">
        <span class="panel-title">ğŸ‘ï¸ Ø­Ø³Ø§Ø³ÛŒØª Ø¨Ø§Ù„Ø§ (Ù‡Ù…Ù‡ Ú†ÛŒØ²)</span>
        <p class="panel-desc">Ø­ØªÛŒ Ø­Ø±Ú©Øª Ø¨Ø±Ú¯ Ø¯Ø±Ø®Øª ÛŒØ§ Ø­Ø´Ø±Ø§Øª Ø±Ø§ Ù…ÛŒâ€ŒÚ¯ÛŒØ±Ø¯.</p>
        
        <canvas id="canvas1"></canvas>
        <div class="status" id="status1">Ø®Ø§Ù…ÙˆØ´</div>
        
        <div class="btn-row">
            <button class="btn-start" onclick="startSystem('sensitive')">Ø´Ø±ÙˆØ¹</button>
            <button class="btn-stop" onclick="stopSystem()">ØªÙˆÙ‚Ù</button>
        </div>
    </div>

    <!-- Ù¾Ù†Ù„ Û²: ÙÙ‚Ø· Ø¨Ø²Ø±Ú¯ -->
    <div class="panel" id="panel-heavy">
        <span class="panel-title">ğŸ˜ Ø§Ø´ÛŒØ§Ø¡ Ø¨Ø²Ø±Ú¯â€ŒØªØ± Ø§Ø² Ú¯Ø±Ø¨Ù‡</span>
        <p class="panel-desc">ÙÙ‚Ø· Ø­Ø±Ú©Øª Ø§Ù†Ø³Ø§Ù† Ùˆ Ù…Ø§Ø´ÛŒÙ† Ø±Ø§ Ø¢Ú˜ÛŒØ± Ù…ÛŒâ€ŒÚ©Ø´Ø¯.</p>
        
        <canvas id="canvas2"></canvas>
        <div class="status" id="status2">Ø®Ø§Ù…ÙˆØ´</div>
        
        <div class="btn-row">
            <button class="btn-start" onclick="startSystem('heavy')">Ø´Ø±ÙˆØ¹</button>
            <button class="btn-stop" onclick="stopSystem()">ØªÙˆÙ‚Ù</button>
        </div>
    </div>

</div>

<script>
// ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø³Ø±Ø§Ø³Ø±ÛŒ
const video = document.getElementById("video");
let currentStream = null;
let currentMode = null; 
let audioCtx = null;
let oscillator = null;
let lastFrame = null;
let analysisLoop = null;

// ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø­Ø³Ø§Ø³ÛŒØª
const CONFIG = {
    sensitive: {
        threshold: 3000,      // Ø­Ø³Ø§Ø³ÛŒØª Ø²ÛŒØ§Ø¯
        pixelSkip: 4,         
        soundFreq: 1200,      // ØµØ¯Ø§ÛŒ Ø²ÛŒØ±
        soundType: 'sine',
        canvasId: 'canvas1',
        panelId: 'panel-sensitive',
        statusId: 'status1'
    },
    heavy: {
        threshold: 60000,     // Ø­Ø³Ø§Ø³ÛŒØª Ú©Ù… (ÙÙ‚Ø· Ø§Ø¬Ø³Ø§Ù… Ø¨Ø²Ø±Ú¯)
        pixelSkip: 8,         
        soundFreq: 150,       // ØµØ¯Ø§ÛŒ Ø¨Ù… (Ø®Ø·Ø±)
        soundType: 'sawtooth',
        canvasId: 'canvas2',
        panelId: 'panel-heavy',
        statusId: 'status2'
    }
};

// --- ØªÙˆØ§Ø¨Ø¹ ØµØ¯Ø§ ---
function startAlarm(type) {
    if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    if (oscillator) return; 

    oscillator = audioCtx.createOscillator();
    const gainNode = audioCtx.createGain();
    
    const settings = CONFIG[type];
    oscillator.type = settings.soundType;
    oscillator.frequency.value = settings.soundFreq;
    
    gainNode.gain.value = 0.2; 
    
    oscillator.connect(gainNode);
    gainNode.connect(audioCtx.destination);
    oscillator.start();
}

function stopAlarm() {
    if (oscillator) {
        try {
            oscillator.stop();
            oscillator.disconnect();
        } catch(e) {}
        oscillator = null;
    }
}

// --- Ù…Ø¯ÛŒØ±ÛŒØª Ø³ÛŒØ³ØªÙ… ---
async function startSystem(mode) {
    if (currentMode) stopSystem();

    currentMode = mode;
    const settings = CONFIG[mode];

    document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
    document.getElementById(settings.panelId).classList.add('active');
    updateStatus("Ø¯Ø± Ø­Ø§Ù„ Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ...", false);

    try {
        if (!currentStream) {
            currentStream = await navigator.mediaDevices.getUserMedia({
                video: { facingMode: "environment", width: 640, height: 480 },
                audio: false
            });
            video.srcObject = currentStream;
            
            await new Promise(r => video.onloadedmetadata = r);
            video.play();
        }

        lastFrame = null;
        updateStatus("ğŸŸ¢ ÙØ¹Ø§Ù„ - Ø¯Ø± Ø­Ø§Ù„ Ù†Ú¯Ù‡Ø¨Ø§Ù†ÛŒ", false);
        detectMotion();

    } catch (err) {
        console.error(err);
        updateStatus("âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¯ÙˆØ±Ø¨ÛŒÙ†", false);
        currentMode = null;
    }
}

function stopSystem() {
    if (!currentMode) return;
    
    stopAlarm();
    
    document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
    updateStatus("Ø®Ø§Ù…ÙˆØ´", false);
    
    const canvas = document.getElementById(CONFIG[currentMode].canvasId);
    const ctx = canvas.getContext("2d");
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    currentMode = null;
    cancelAnimationFrame(analysisLoop);
}

function updateStatus(text, isAlert) {
    if (!currentMode) return;
    const el = document.getElementById(CONFIG[currentMode].statusId);
    el.textContent = text;
    el.className = isAlert ? "status alert" : "status";
}

// --- Ù‡Ø³ØªÙ‡ Ù¾Ø±Ø¯Ø§Ø²Ø´ ØªØµÙˆÛŒØ± ---
function detectMotion() {
    if (!currentMode) return;

    analysisLoop = requestAnimationFrame(detectMotion);

    if (video.readyState !== 4 || video.videoWidth === 0) return;

    const settings = CONFIG[currentMode];
    const canvas = document.getElementById(settings.canvasId);
    const ctx = canvas.getContext("2d");

    if (canvas.width !== video.videoWidth) {
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
    }

    // Ø±Ø³Ù… ØªØµÙˆÛŒØ± Ø²Ù†Ø¯Ù‡
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

    // Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø±ÙˆÛŒ Ù†Ø³Ø®Ù‡ Ø¨Ø³ÛŒØ§Ø± Ú©ÙˆÚ†Ú©
    const w = currentMode === 'heavy' ? 32 : 64;
    const h = currentMode === 'heavy' ? 24 : 48;
    
    const tempCanvas = document.createElement('canvas');
    tempCanvas.width = w;
    tempCanvas.height = h;
    const tctx = tempCanvas.getContext('2d');
    tctx.drawImage(video, 0, 0, w, h);
    
    const frame = tctx.getImageData(0, 0, w, h);

    if (lastFrame) {
        let diff = 0;
        const data = frame.data;
        const lastData = lastFrame.data;
        const skip = settings.pixelSkip;

        for (let i = 0; i < data.length; i += 4 * skip) {
            const d = Math.abs(data[i+1] - lastData[i+1]);
            if (d > 20) { 
                diff += d;
            }
        }

        if (diff > settings.threshold) {
            updateStatus("ğŸš¨ ÙˆØ±ÙˆØ¯ ØºÛŒØ±Ù…Ø¬Ø§Ø²!", true);
            startAlarm(currentMode);

            ctx.strokeStyle = "red";
            ctx.lineWidth = 5;
            ctx.strokeRect(10, 10, canvas.width - 20, canvas.height - 20);
            
            // ÙÙ„Ø´ Ù‚Ø±Ù…Ø² Ø±ÙˆÛŒ ØªØµÙˆÛŒØ± Ø¨Ø±Ø§ÛŒ Ø¬Ù„Ø¨ ØªÙˆØ¬Ù‡
            ctx.fillStyle = "rgba(255, 0, 0, 0.3)";
            ctx.fillRect(0, 0, canvas.width, canvas.height);
        } else {
            updateStatus("ğŸŸ¢ Ø§Ù…Ù†", false);
            stopAlarm();
        }
    }

    lastFrame = frame;
}
</script>

</body>
</html>

