<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Object Detection (Coco-SSD)</title>
    <style>
        body { margin: 0; background: #222; overflow: hidden; display: flex; flex-direction: column; height: 100vh; }
        video { position: absolute; min-width: 100%; min-height: 100%; object-fit: cover; }
        canvas { position: absolute; min-width: 100%; min-height: 100%; object-fit: cover; }
        #info { position: absolute; top: 10px; left: 10px; z-index: 20; color: yellow; background: rgba(0,0,0,0.7); padding: 5px; }
    </style>
    <!-- لود کتابخانه‌ها -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.18.0/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd"></script>
</head>
<body>
    <div id="info">Loading Object Detection...</div>
    <video id="video" playsinline muted autoplay></video>
    <canvas id="canvas"></canvas>

    <script>
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const info = document.getElementById('info');
        let model;

        async function start() {
            try {
                // 1. راه اندازی دوربین
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'environment' }, 
                    audio: false 
                });
                video.srcObject = stream;
                
                await new Promise(r => video.onloadedmetadata = r);
                video.play();
                
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;

                // 2. لود مدل
                info.innerText = "Loading Model...";
                model = await cocoSsd.load();
                info.innerText = "Running...";
                
                predict();
            } catch (e) {
                info.innerText = "Error: " + e.message;
            }
        }

        async function predict() {
            // اصلاح سایز کانواس در صورت چرخش گوشی
            if (canvas.width !== video.videoWidth) {
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
            }

            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // کشیدن مستطیل‌ها
            if(model) {
                const predictions = await model.detect(video);
                predictions.forEach(prediction => {
                    const [x, y, width, height] = prediction.bbox;
                    
                    ctx.strokeStyle = '#00FFFF';
                    ctx.lineWidth = 4;
                    ctx.strokeRect(x, y, width, height);
                    
                    ctx.fillStyle = '#00FFFF';
                    ctx.font = '18px Arial';
                    ctx.fillText(prediction.class + ' ' + Math.round(prediction.score * 100) + '%', x, y > 10 ? y - 5 : 10);
                });
            }

            requestAnimationFrame(predict);
        }

        start();
    </script>
</body>
</html>